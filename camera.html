<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Direct Stream Player</title>
	<style>
		body, html {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			background: #000;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		video {
			width: 100%;
			height: 100%;
			object-fit: contain;
		}
		#status {
			position: absolute;
			top: 10px;
			right: 10px;
			background: rgba(0, 0, 0, 0.7);
			color: #fff;
			padding: 5px 10px;
			font-family: Arial, sans-serif;
			font-size: 12px;
			border-radius: 3px;
			z-index: 1000;
			/* Hide status for OBS - uncomment the line below */
			/* display: none; */
		}
		#error {
			color: white;
			text-align: center;
			padding: 20px;
			display: none;
		}
	</style>
</head>

<body>
	<div id="status">Fetching stream...</div>
	<video id="player" controls autoplay playsinline></video>
	<div id="error"></div>

	<script>

		function getStreamAliasFromUrl() {
			const urlParams = new URLSearchParams(window.location.search);
			const alias = urlParams.get('alias'); 
			return alias || '5582ee930f0e6';
		}

		const streamAlias = getStreamAliasFromUrl();
		const refreshInterval = 1000 * 60 * 8;

		function updateStatus(message) {
			document.getElementById('status').textContent = message;
			console.log('Status:', message);
		}

		function showError(message) {
			const errorEl = document.getElementById('error');
			errorEl.textContent = message;
			errorEl.style.display = 'block';
			document.getElementById('player').style.display = 'none';
		}

		async function fetchStreamData() {
			try {
				// First, get the stream info
				const infoUrl = `https://www.ipcamlive.com/player/getcamerastreamstate.php?alias=${streamAlias}`;
				updateStatus('Fetching stream info...');
				
				// If you need it, the path to the logo would be, eg.: https://www.ipcamlive.com/resources/logos/668bfc5eaf02c.jpg
				// The snapshot would be: https://s103.ipcamlive.com/streams/670lktcof5alnrjun/snapshot.jpg
				// There is also a remote player at, eg. https://g0.ipcamlive.com/player/player.php?alias=6745eb6be37dd

				const response = await fetch(infoUrl);
				const data = await response.json();
				
				if (data && data.details) {
					const details = data.details;
					console.log('Stream details:', details);
					
					// Construct the direct stream URL
					const streamUrl = `${details.address}streams/${details.streamid}/stream.m3u8`;
					
					updateStatus('Loading direct stream...');
					return streamUrl;
				}
			} catch (error) {
				console.error('Error fetching stream data:', error);
				return null;
			}
		}

		async function loadStream() {
			const video = document.getElementById('player');
			
			const url = await fetchStreamData()

  

			// Check if browser supports HLS natively (Safari)
			try {
				updateStatus(`Trying ${url}...`);
				video.src = url;
				
				// Wait for video to start playing
				await new Promise((resolve, reject) => {
					video.addEventListener('loadeddata', resolve, { once: true });
					video.addEventListener('error', reject, { once: true });
					setTimeout(reject, 5000); // 5 second timeout (reduced from 10)
				});
				
				await video.play();
				updateStatus('Stream playing');
				scheduleRefresh();
				return;
			} catch (error) {
				console.log(`Failed to load ${url}:`, error);
			}


			// If direct URLs don't work, try with HLS.js library
			updateStatus('Loading HLS library...');
			const script = document.createElement('script');
			script.src = 'https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js';
			script.onload = () => {
				if (Hls.isSupported()) {
					const hls = new Hls({
						enableWorker: true,
						lowLatencyMode: true,
						xhrSetup: function(xhr, url) {
							xhr.withCredentials = false;
						}
					});
					
					tryHlsUrls(hls, url);
				} else {
					showError('HLS is not supported in this browser');
				}
			};
			document.head.appendChild(script);
		}

		function tryHlsUrls(hls, url) {
		   
  
				hls.loadSource(url);
				hls.attachMedia(document.getElementById('player'));
				
				hls.on(Hls.Events.MANIFEST_PARSED, () => {
					document.getElementById('player').play();
					updateStatus('Stream playing via HLS');
					scheduleRefresh();
				});
				
				hls.on(Hls.Events.ERROR, (event, data) => {
					console.log('HLS Error:', data);
					if (data.fatal) {
						hls.destroy();
						tryNextUrl();
					}
				});
			}
			

		function scheduleRefresh() {
			setTimeout(() => {
				updateStatus('Refreshing stream...');
				location.reload();
			}, refreshInterval);
		}

		// Start loading when page loads
		window.addEventListener('load', () => {
			loadStream();
		});

		// Ensure video keeps playing
		document.getElementById('player').addEventListener('pause', () => {
			const video = document.getElementById('player');
			if (video.paused) {
				video.play().catch(e => console.log('Play failed:', e));
			}
		});

	</script>
</body>
</html>
