<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Stream Player</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 5px 10px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            border-radius: 3px;
            z-index: 1000;
            /* Hide status for OBS - uncomment the line below */
            /* display: none; */
        }
        #error {
            color: white;
            text-align: center;
            padding: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="status">Fetching stream...</div>
    <video id="player" controls autoplay muted playsinline></video>
    <div id="error"></div>

    <script>
        const streamAlias = '5582ee930f0e6';
        const refreshInterval = 4 * 60 * 1000; // 4 minutes
        let retryCount = 0;
        const maxRetries = 3;

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('Status:', message);
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('player').style.display = 'none';
        }

        async function fetchStreamData() {
            try {
                // First, get the stream info
                const infoUrl = `https://ipcamlive.com/player/getstreaminfo.php?alias=${streamAlias}`;
                updateStatus('Fetching stream info...');
                
                const response = await fetch(infoUrl);
                const data = await response.json();
                
                if (data && data.details) {
                    const details = data.details;
                    console.log('Stream details:', details);
                    
                    // Construct the direct stream URL
                    // Based on the response, the stream is at s52.ipcamlive.com
                    // with streamid: 34qilxrrbu0vy1gfy
                    const streamUrl = `${details.address}streams/${details.streamid}/stream.m3u8`;
                    
                    updateStatus('Loading direct stream...');
                    return streamUrl;
                }
            } catch (error) {
                console.error('Error fetching stream data:', error);
                return null;
            }
        }

        async function loadStream() {
            const video = document.getElementById('player');
            
            // Try direct HLS URL based on the pattern
            const directUrls = [
                'http://s52.ipcamlive.com/streams/34qilxrrbu0vy1gfy/stream.m3u8',
                'https://s52.ipcamlive.com/streams/34qilxrrbu0vy1gfy/stream.m3u8',
                'http://s52.ipcamlive.com/streams/34qilxrrbu0vy1gfy/index.m3u8',
                'http://s52.ipcamlive.com:6017/streams/34qilxrrbu0vy1gfy/stream.m3u8'
            ];

            // Check if browser supports HLS natively (Safari)
            for (const url of directUrls) {
                try {
                    updateStatus(`Trying ${url}...`);
                    video.src = url;
                    
                    // Wait for video to start playing
                    await new Promise((resolve, reject) => {
                        video.addEventListener('loadeddata', resolve, { once: true });
                        video.addEventListener('error', reject, { once: true });
                        setTimeout(reject, 5000); // 5 second timeout (reduced from 10)
                    });
                    
                    await video.play();
                    updateStatus('Stream playing');
                    scheduleRefresh();
                    return;
                } catch (error) {
                    console.log(`Failed to load ${url}:`, error);
                }
            }

            // If direct URLs don't work, try with HLS.js library
            updateStatus('Loading HLS library...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js';
            script.onload = () => {
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        xhrSetup: function(xhr, url) {
                            xhr.withCredentials = false;
                        }
                    });
                    
                    tryHlsUrls(hls, directUrls);
                } else {
                    showError('HLS is not supported in this browser');
                }
            };
            document.head.appendChild(script);
        }

        function tryHlsUrls(hls, urls) {
            let urlIndex = 0;
            
            function tryNextUrl() {
                if (urlIndex >= urls.length) {
                    if (retryCount < maxRetries) {
                        retryCount++;
                        updateStatus(`Retry attempt ${retryCount}/${maxRetries}...`);
                        setTimeout(() => loadStream(), 5000);
                    } else {
                        showError('Could not load stream. The stream might be blocking direct access.');
                    }
                    return;
                }
                
                const url = urls[urlIndex++];
                updateStatus(`Trying HLS: ${url}...`);
                
                hls.loadSource(url);
                hls.attachMedia(document.getElementById('player'));
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    document.getElementById('player').play();
                    updateStatus('Stream playing via HLS');
                    scheduleRefresh();
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.log('HLS Error:', data);
                    if (data.fatal) {
                        hls.destroy();
                        tryNextUrl();
                    }
                });
            }
            
            tryNextUrl();
        }

        function scheduleRefresh() {
            setTimeout(() => {
                updateStatus('Refreshing stream...');
                location.reload();
            }, refreshInterval);
        }

        // Start loading when page loads
        window.addEventListener('load', () => {
            loadStream();
        });

        // Ensure video keeps playing
        document.getElementById('player').addEventListener('pause', () => {
            const video = document.getElementById('player');
            if (video.paused) {
                video.play().catch(e => console.log('Play failed:', e));
            }
        });
    </script>
</body>
</html>
